using Robust.Client.AutoGenerated;

using Robust.Client.ResourceManagement;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;
using Robust.Client.UserInterface;
using Content.Client.Stylesheets;
using static Robust.Client.UserInterface.Controls.BaseButton;
using static Robust.Client.UserInterface.Controls.BoxContainer;

namespace Content.Client.PlayingCard.UI
{
    [GenerateTypedNameReferences]
    public partial class PlayingCardHandWindow : DefaultWindow
    {
        [Dependency] private readonly IResourceCache _resourceCache = default!;
        [Dependency] private readonly IPrototypeManager _prototypeManager = default!;

        private PlayingCardHandBoundUserInterface Owner { get; }

        private List<String> _cachedCardList = new();

        private int _cardOffset = 0;

        private int _cardPageLimit = 5;
        public PlayingCardHandWindow(PlayingCardHandBoundUserInterface owner)
        {
            IoCManager.InjectDependencies(this);
            RobustXamlLoader.Load(this);

            Owner = owner;
            IoCManager.Resolve<IResourceCache>();
            // VendingContents.OnItemSelected += ItemSelected;

            ScrollRight.OnPressed += e => ChangeOffset(1);
            ScrollLeft.OnPressed += e => ChangeOffset(-1);
        }

        public void Populate(List<String> cardList)
        {
            CardList.RemoveAllChildren();

            _cachedCardList = cardList;

            int start = Math.Max(0, ((cardList.Count - 1) - _cardOffset));
            int end = Math.Max(0, ((start + 1) - _cardPageLimit));

            for (int i = start; i >= end ; i--) {

            var button = new CardButton
            {
                CardName = cardList[i],
                Index = i
            };

            // var rect = button.EntityTextureRects;
            // rect.Textures = SpriteComponent.GetPrototypeTextures(prototype, resourceCache).Select(o => o.Default).ToList();
                button.ActualButton.OnPressed += OnCardSelected;
                button.CardNameLabel.SetMessage(cardList[i]);
                CardList.AddChild(button);
            }


        }

        private void ChangeOffset(float offsetChange)
        {
            if (!((_cachedCardList.Count - 1) < _cardPageLimit))
            {
                var newOffset = _cardOffset + offsetChange;
                if ((newOffset < 0) || (newOffset > _cachedCardList.Count - 1))
                    return;

                _cardOffset = (int)newOffset;
                Populate(_cachedCardList);
                return;
            }
            if (_cardOffset > 0)
                _cardOffset = 0;
        }

        protected override void MouseWheel(GUIMouseWheelEventArgs args)
        {
            base.MouseWheel(args);
            ChangeOffset(args.Delta.Y);
        }

        private void OnCardSelected(BaseButton.ButtonEventArgs args)
        {
            var item = (CardButton) args.Button.Parent!;
            Owner.RemoveCard(item.Index);
        }

        private sealed class CardButton : Control
        {
            public string CardName { get; set; } = default!;
            public Button ActualButton { get; private set; }
            public RichTextLabel CardNameLabel { get; private set; }
            // public LayeredTextureRect EntityTextureRects { get; private set; }
            public int Index { get; set; }

            public CardButton()
            {
                AddChild(ActualButton = new Button
                {
                });

                AddChild(new BoxContainer
                {
                    Orientation = LayoutOrientation.Vertical,
                    MinSize = (125, 200),
                    MaxSize = (125, 200),
                    Children =
                    {
                        // (EntityTextureRects = new LayeredTextureRect
                        // {
                        //     MinSize = (32, 32),
                        //     HorizontalAlignment = HAlignment.Center,
                        //     VerticalAlignment = VAlignment.Top,
                        //     // Stretch = TextureRect.StretchMode.KeepAspectCentered,
                        //     CanShrink = true
                        // }),
                        (CardNameLabel = new RichTextLabel
                        {
                            VerticalAlignment = VAlignment.Center,
                            HorizontalAlignment = HAlignment.Center,
                            HorizontalExpand = false,
                        })
                    }
                });
            }
        }

        public class EntityContainerButton : ContainerButton
    {
        public string CardName;

        public EntityContainerButton(string cardName)
        {
            CardName = cardName;
            AddStyleClass(StyleNano.StyleClassStorageButton);
        }
    }
    }
}
